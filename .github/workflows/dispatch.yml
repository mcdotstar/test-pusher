name: Dispatch
on:
  created:
  deleted:

jobs:
  dispatch:
    if: github.event.ref_type == 'tag'
    name: Dispatch tag
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repo: ['mcdotstar/test-receiver']
    timeout-minutes: 5
    steps:
      - name: Construct creation payload
        if: github.event.created
        shell: bash
        run: echo "REMOVE=0" >> "${GITHUB_ENV}"
        
      - name: Construct deletion payload
        if: github.event.deleted
        shell: bash
        run: echo "REMOVE=1" >> "${GITHUB_ENV}"
        
      - name: Extract referenced tag
        shell: bash
        run: |
          reference=${{ github.event.ref }}
          refarray=(${reference//// })
          echo "TAG=${refarray[2]}" >> "${GITHUB_ENV}"
        
      - name: Repository Dispatch
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.RECEIVER_TOKEN }}
          repository: ${{ matrix.repo }}
          event-type: update_tag
          client-payload: |-
            {
              "remove": "${{ env.REMOVE }}",
              "tag": "${{ env.TAG }}"
            }
